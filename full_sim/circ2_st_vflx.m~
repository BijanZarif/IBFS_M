function [q, s] = circ2_st_vflx( gamma, parms, mats )

%Take vorticity on all grids and return vel flux and streamfunction


m = parms.m; n = parms.n; mg = parms.mg;
nq = (m-1)*n + (n-1) * m; ngam = (m-1)*(n-1);

q = zeros( nq, mg );
s = zeros( ngam, mg );

for j = mg : -1 : 1

    %--Solve Poisson problem for stfn
    
        %BCs for Poisson problem (will be overwritten if mg > 1)
        stbc = zeros( ngam, 1 );
    
        %don't need bcs for largest grid
        if ( j == mg ) 
            
            %Solve for streamfcn
            s(:,j) = RCinv( gamma(:,j), parms, mats );
            
        %get bcs for other grid levels
        else
            
            %Get bcs from streamfunction on coarser gridlevel
            stbc = get_stfn_BCs( stbc, s(:,j+1), parms );
            
            %Solve for streamfcn
            s(:,j) = RCinv( gamma(:,j) + stbc, parms, mats );
            
        end

    %--

    %--Get velocity on first grid from stream function

        q = curl( stfn, stbc, parms );
        % (1 because we are applying curl to first grid level)
    %--
    
end

